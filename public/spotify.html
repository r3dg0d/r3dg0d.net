<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#00000f">
    <meta name="description" content="r3dg0d - Spotify Listening History">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://r3dg0d.net/spotify">
    <meta property="og:title" content="Spotify - r3dg0d">
    <meta property="og:description" content="What I've been listening to">
    
    <title>Spotify - r3dg0d</title>
    <link rel="icon" type="image/jpeg" href="/favicon.jpg">
    <link rel="stylesheet" href="/styles.css">
    <style>
        .spotify-container {
            max-width: 48rem;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .spotify-header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .spotify-nav {
            margin-bottom: 1rem;
        }
        
        .spotify-nav a {
            color: var(--text-muted);
            font-size: 0.75rem;
            transition: color 0.15s ease;
        }
        
        .spotify-nav a:hover {
            color: var(--text-primary);
        }
        
        .spotify-title {
            font-family: var(--font-proggy);
            font-size: 3rem;
            margin-bottom: 0.5rem;
            color: #1DB954;
        }
        
        .spotify-subtitle {
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        .now-playing {
            background: linear-gradient(135deg, rgba(29, 185, 84, 0.1) 0%, rgba(29, 185, 84, 0.05) 100%);
            border: 1px solid rgba(29, 185, 84, 0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .now-playing-label {
            color: #1DB954;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #1DB954;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }
        
        .now-playing-content {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .now-playing-art {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            object-fit: cover;
        }
        
        .now-playing-info h3 {
            color: var(--text-primary);
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }
        
        .now-playing-info p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .recently-played {
            margin-top: 2rem;
        }
        
        .section-title {
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .track-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .track-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            transition: all 0.15s ease;
        }
        
        .track-item:hover {
            border-color: rgba(29, 185, 84, 0.3);
            background: rgba(29, 185, 84, 0.05);
        }
        
        .track-number {
            color: var(--text-muted);
            font-size: 0.75rem;
            width: 1.5rem;
            text-align: center;
        }
        
        .track-art {
            width: 40px;
            height: 40px;
            border-radius: 0.25rem;
            object-fit: cover;
        }
        
        .track-info {
            flex: 1;
            min-width: 0;
        }
        
        .track-title {
            color: var(--text-primary);
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-artist {
            color: var(--text-muted);
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-time {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
    <canvas id="starfield" class="fixed top-0 left-0 w-full h-full pointer-events-none z-0"></canvas>
    
    <div class="spotify-container relative">
        <div class="spotify-header">
            <nav class="spotify-nav">
                <a href="/">← back to home</a>
            </nav>
            <h1 class="spotify-title">spotify</h1>
            <p class="spotify-subtitle">what i've been listening to</p>
        </div>
        
        <div id="now-playing-section" class="now-playing" style="display: none;">
            <div class="now-playing-label">
                <div class="pulse-dot"></div>
                Now Playing
            </div>
            <div class="now-playing-content">
                <img src="/favicon.jpg" alt="Album Art" class="now-playing-art" id="np-art">
                <div class="now-playing-info">
                    <h3 id="np-title">Loading...</h3>
                    <p id="np-artist">—</p>
                </div>
            </div>
        </div>
        
        <div class="recently-played">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                Recently Played
            </h2>
            <div id="track-list" class="track-list">
                <div class="loading">Loading listening history...</div>
            </div>
        </div>
    </div>
    
    <script>
        // Starfield
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        let stars = [];
        
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function createStars() {
            stars = [];
            for (let i = 0; i < 150; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 1.5 + 0.5,
                    opacity: Math.random() * 0.5 + 0.3,
                    twinkle: Math.random() * Math.PI * 2
                });
            }
        }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(star => {
                star.twinkle += 0.02;
                const opacity = star.opacity + Math.sin(star.twinkle) * 0.2;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.max(0.1, Math.min(1, opacity))})`;
                ctx.fill();
            });
            requestAnimationFrame(animate);
        }
        resize(); createStars(); animate();
        window.addEventListener('resize', () => { resize(); createStars(); });
        
        // Format time ago
        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(mins / 60);
            const days = Math.floor(hours / 24);
            
            if (mins < 1) return 'just now';
            if (mins < 60) return `${mins}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }
        
        // Load now playing
        async function loadNowPlaying() {
            try {
                const response = await fetch('/api/spotify/now-playing');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.isPlaying && data.item) {
                        const section = document.getElementById('now-playing-section');
                        const art = document.getElementById('np-art');
                        const title = document.getElementById('np-title');
                        const artist = document.getElementById('np-artist');
                        
                        section.style.display = 'block';
                        title.textContent = data.item.name;
                        artist.textContent = data.item.artists.map(a => a.name).join(', ');
                        
                        if (data.item.album?.images?.length > 0) {
                            art.src = data.item.album.images[0].url;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading now playing:', error);
            }
        }
        
        // Load recently played
        async function loadRecentlyPlayed() {
            const container = document.getElementById('track-list');
            
            try {
                const response = await fetch('/api/spotify/recently-played?limit=20');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.items || data.items.length === 0) {
                    container.innerHTML = '<div class="loading">No recent tracks found.</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                data.items.forEach((item, index) => {
                    const track = item.track;
                    const trackDiv = document.createElement('div');
                    trackDiv.className = 'track-item';
                    
                    const albumArt = track.album?.images?.[2]?.url || track.album?.images?.[0]?.url || '/favicon.jpg';
                    const artists = track.artists.map(a => a.name).join(', ');
                    
                    trackDiv.innerHTML = `
                        <span class="track-number">${index + 1}</span>
                        <img src="${albumArt}" alt="Album" class="track-art">
                        <div class="track-info">
                            <div class="track-title">${track.name}</div>
                            <div class="track-artist">${artists}</div>
                        </div>
                        <span class="track-time">${timeAgo(item.played_at)}</span>
                    `;
                    
                    trackDiv.addEventListener('click', () => {
                        if (track.external_urls?.spotify) {
                            window.open(track.external_urls.spotify, '_blank');
                        }
                    });
                    trackDiv.style.cursor = 'pointer';
                    
                    container.appendChild(trackDiv);
                });
            } catch (error) {
                console.error('Error loading recently played:', error);
                container.innerHTML = `<div class="error">Error loading listening history: ${error.message}</div>`;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadNowPlaying();
            loadRecentlyPlayed();
            
            // Refresh now playing every 30 seconds
            setInterval(loadNowPlaying, 30000);
        });
    </script>
</body>
</html>

